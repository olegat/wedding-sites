#include "defines.h"

#define PLUS1_NAME_SPANS \
(<span lang="en" class="plus1name" data-defaultname="+1">+1</span><span lang="es" class="plus1name" data-defaultname="acompañante">acompañante</span><span lang="fr" class="plus1name" data-defaultname="+1">+1</span>)

#define DIET_EXAMPLES_SPANS \
   <span class="placeholder" lang="en">e.g. nuts, gluten</span>\
   <span class="placeholder" lang="en">e.g. vegan, vegetarian</span>\
   <span class="placeholder" lang="es">p.ej. vegano, vegetariano</span>\
   <span class="placeholder" lang="es">p.ej. nueces, gluten</span>\
   <span class="placeholder" lang="fr">ex. noix, gluten</span>\
   <span class="placeholder" lang="fr">ex. végan, végétarien</span>\

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>RSVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* GLOBAL BOX MODEL FIX */
      *, *::before, *::after {
        box-sizing: border-box;
      }

      /* LANGUAGE HANDLING */
      span[lang] { display: none; }
      div[lang] { display: none; }
      html[lang="en"] [lang="en"],
      html[lang="es"] [lang="es"],
      html[lang="fr"] [lang="fr"] { display: inline; }

      body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
          line-height: 1.4;
          margin: 2rem auto;
          max-width: 600px;
          padding: 0 1rem;
      }
      textarea {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      label,
      legend {
          display: block;
          font-weight: 600;
          margin-top: 1rem;
      }

      input[type="text"], input[type="email"], select, textarea, button {
          font-size: 1rem;
          margin-top: 0.4rem;
          padding: 0.6rem;
          width: 100%;
      }

      .radio-group {
          margin-top: 1rem;
          border: none;
          margin-inline: 0;
          margin-top: 1rem;
          padding: 0;
      }
      .radio-group label {
          display: inline-block;
          font-weight: normal;
          margin-right: 1rem;
      }
      .no-margin-top {
          margin-top: 0rem;
      }

      .diet-group {
          border: none;
          margin-inline: 0;
          margin-top: 1rem;
          padding: 0;
      }

      legend {
          font-weight: 600;
          padding-inline: 0;
      }

      .hidden {
          display: none;
      }

      .success {
          color: #0a7a0a;
          font-weight: 600;
          margin-top: 2rem;
      }

      .disabled {
          opacity: 0.5;
          pointer-events: none;
      }

      .diet-row {
          align-items: start;
          display: grid;
          gap: 0.5rem;
          grid-template-columns: 1fr 1fr;
      }

      .placeholder {
          color: #555;
          display: block;
          font-size: 0.9rem;
          font-weight: normal;
          margin-top: 0.2rem;
      }

      .questioninfo {
          color: #666;
          font-size: 0.9em;
          font-style: italic;
          font-weight: normal;
          line-height: 1.4;
          margin-top: 0.25rem;
      }

      .mainq {
          margin-top: 1.5rem;
      }

      .redstar::after {
          content: '*';
          color: #f00;
      }

      /* Hide the "Required" star if an ancestor is disabled */
      .disabled  .redstar,
      [disabled] .redstar {
          display: none;
      }
    </style>
    <script src="./language.js"></script>
  </head>

  <body>
    <!--
        TODO:
        [v]  Repeat dates of wedding and preboda
        [v]  Add red * for required field
        [ ]  Hook to Getform.io
    -->
    <h1>
      <span lang="en">RSVP</span>
      <span lang="es">Confirmación</span>
      <span lang="fr">RSVP</span>
    </h1>

    <form id="rsvp-form" method="POST" action="https://getform.io/f/bdrkrodb">
      <!-- LANGUAGE SELECT -->
      <div class="mainq">
        <label>
          <span lang="en">Language</span>
          <span lang="es">Idioma</span>
          <span lang="fr">Langue</span>
          <span class="redstar"></span>
          <select name="lang" id="lang-select">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
          </select>
        </label>
      </div>

      <!-- NAME -->
      <div class="mainq">
        <label>
          <span lang="en">Name</span>
          <span lang="es">Nombre</span>
          <span lang="fr">Nom</span>
          <span class="redstar"></span>
          <input name="name" type="text" required />
        </label>
      </div>

      <!-- EMAIL -->
      <div class="mainq">
        <label>
          <span lang="en">Email</span>
          <span lang="es">Correo electrónico</span>
          <span lang="fr">E-mail</span>
          <span class="redstar"></span>
          <div class="questioninfo">
            <span lang="en">We&#39;ll use this email address to send you updates.</span>
            <span lang="es">Usaremos esta dirección de correo para enviarle actualizaciones.</span>
            <span lang="fr">Nous utiliserons cette adresse e-mail pour vous envoyer des informations.</span>
          </div>
          <input name="email" type="email" required />
        </label>
      </div>

      <!-- ATTENDING? RADIO -->
      <div class="mainq">
        <fieldset class="radio-group" id="attending-fieldset">
          <legend>
            <span lang="en">Attending?</span>
            <span lang="es">¿Asistirá?</span>
            <span lang="fr">Présence ?</span>
            <span class="redstar"></span>
          </legend>
          <div class="questioninfo">
            <span lang="en">The wedding will take place on Saturday 10 October 2026 in Zaragoza, Spain.</span>
            <span lang="es">La boda tendrá lugar el sábado 10 de octubre de 2026 en Zaragoza, España.</span>
            <span lang="fr">Le mariage aura lieu le samedi 10 octobre 2026 à Saragosse en Espagne.</span>
          </div>
          <label><input type="radio" name="attending" value="yes" required /> <span lang="en">Yes</span><span lang="es">Sí</span><span lang="fr">Oui</span></label>
          <label><input type="radio" name="attending" value="no" checked required /> <span lang="en">No</span><span lang="es">No</span><span lang="fr">Non</span></label>
        </fieldset>
      </div>

      <!-- 1. +1 -->
      <div class="mainq">
        <fieldset class="radio-group" id="plus1-fieldset">
          <legend>
            <span lang="en">Will you be bringing a +1?</span>
            <span lang="es">¿Traerá acompañante?</span>
            <span lang="fr">Allez-vous venir avec un +1 ?</span>
            <span class="redstar"></span>
          </legend>
          <label><input type="radio" name="plus1" value="yes" /> <span lang="en">Yes</span><span lang="es">Sí</span><span lang="fr">Oui</span></label>
          <label><input type="radio" name="plus1" value="no" checked /> <span lang="en">No</span><span lang="es">No</span><span lang="fr">Non</span></label>
        </fieldset>
      </div>

      <!-- 2. +1 Name -->
      <div class="mainq plus1-row">
        <label id="plus1-name-label">
          <span lang="en">+1 Name</span>
          <span lang="es">Nombre del acompañante</span>
          <span lang="fr">Nom du +1</span>
          <span class="redstar"></span>
          <input id="plus1-name-input" name="plus1_name" type="text" required />
        </label>
      </div>

      <!-- Kids -->
      <div class="mainq">
        <label id="kid-count-label">
          <span lang="en">How many child guests will you be bringing?</span>
          <span lang="es">¿Cuántos niños traerás?</span>
          <span lang="fr">Combien d’enfants amènerez-vous&nbsp;?</span>
          <span class="redstar"></span>
          <select name="lang" id="kid-count-input">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>
      </div>

      <!-- Kid names -->
      <div class="mainq" id="kid-names-div" style="display: none">
        <label id="kid-names-label">
          <span lang="en">Child names</span>
          <span lang="es">Nombres de los niños</span>
          <span lang="fr">Noms des enfants</span>
          <span class="redstar"></span>
          <input id="kid-name-1" name="kid_name_1" type="text" required />
          <input id="kid-name-2" name="kid_name_2" type="text" required />
          <input id="kid-name-3" name="kid_name_3" type="text" required />
          <input id="kid-name-4" name="kid_name_4" type="text" required />
        </label>
      </div>

      <!-- 3. Dietary -->
      <div class="mainq">
        <fieldset class="diet-group" id="diet-fieldset">
          <legend>
            <span lang="en">Dietary Requirements</span>
            <span lang="es">Requisitos alimentarios</span>
            <span lang="fr">Régimes alimentaires</span>
          </legend>

          <div class="diet-row">
            <legend id="allergies-main-label">
              <span lang="en">Allergies (you)</span>
              <span lang="es">Alergias (usted)</span>
              <span lang="fr">Allergies (vous)</span>
            </legend>
            <legend id="diet-main-label">
              <span lang="en">Dietary choice (you)</span>
              <span lang="es">Dieta (usted)</span>
              <span lang="fr">Régime (vous)</span>
            </legend>
          </div>

          <div class="diet-row">
            <input id="allergies-main" name="allergies_main" type="text" />
            <input id="diet-main" name="diet_main" type="text" />
          </div>

          <div class="diet-row">
            DIET_EXAMPLES_SPANS
          </div>

          <div class="diet-row plus1-row">
            <legend id="allergies-plus1-label">
              <span lang="en">Allergies</span>
              <span lang="es">Alergias</span>
              <span lang="fr">Allergies</span>
              PLUS1_NAME_SPANS
            </legend>
            <legend id="diet-plus1-label">
              <span lang="en">Dietary choice</span>
              <span lang="es">Dieta</span>
              <span lang="fr">Régime</span>
              PLUS1_NAME_SPANS
            </legend>
          </div>

          <div class="diet-row plus1-row">
            <input id="allergies-plus1" name="allergies_plus1" type="text" disabled />
            <input id="diet-plus1" name="diet_plus1" type="text" disabled />
          </div>

          <div class="diet-row plus1-row">
            DIET_EXAMPLES_SPANS
          </div>

        </fieldset>
      </div>

      <!-- 4. Preboda -->
#if USE_PREBODA_PROMPT
      <div class="mainq">
        <fieldset class="radio-group" id="preboda-fieldset">
          <legend>
            <span lang="en">Do you plan on joining the "preboda"?</span>
            <span lang="es">¿Planea asistir a la "preboda"?</span>
            <span lang="fr">Prévoit de rejoindre la "preboda" ?</span>
            <span class="redstar"></span>
          </legend>
          <div class="questioninfo">
            <div lang="en">
              <p>The "preboda" is on: Friday, 9th of October 2026.</p>
              <p>
                This is a casual and informal gathering the day before the wedding.
                It&#39;s a great opportunity to mingle with other guests beforehand.
              </p>
            </div>
            <div lang="es">
              <p>La "preboda" será el viernes 9 de octubre de 2026.</p>
              <p>
                Es un encuentro informal y distendido el día antes de la boda.
                Es una excelente oportunidad para conocer a otros invitados con antelación.
              </p>
            </div>
            <div lang="fr">
              <p>La « preboda » aura lieu le vendredi 9 octobre 2026.</p>
              <p>
                Il s'agit d'une rencontre informelle et conviviale la veille du mariage.
                C'est une excellente occasion de faire connaissance avec les autres invités à l'avance.
              </p>
            </div>
          </div>
          <label>
            <input type="radio" name="preboda" value="yes" />
            <span lang="en">Yes</span><span lang="es">Sí</span><span lang="fr">Oui</span>
          </label>
          <label>
            <input type="radio" name="preboda" value="no" />
            <span lang="en">No</span><span lang="es">No</span><span lang="fr">Non</span></label>
          <label>
            <input type="radio" name="preboda" value="maybe" />
            <span lang="en">Maybe</span><span lang="es">Tal vez</span><span lang="fr">Peut-être</span></label>
        </fieldset>
      </div>
#endif

      <!-- Song request -->
      <div class="mainq">
        <label id="songrequest-label">
          <span lang="en">Any song requests?</span>
          <span lang="es">¿Alguna petición de canción?</span>
          <span lang="fr">Des demandes de chansons&nbsp;?</span>
          <input id="songrequest-input" name="songrequest" type="text" />
        </label>
      </div>

      <!-- 5. Anything else -->
      <div class="mainq">
        <label>
          <span lang="en">Anything else we should know?</span>
          <span lang="es">¿Algo más que debamos saber?</span>
          <span lang="fr">Autre chose à signaler ?</span>
          <textarea name="notes" rows="4"></textarea>
          <span class="placeholder" lang="en">Optional</span>
          <span class="placeholder" lang="es">Opcional</span>
          <span class="placeholder" lang="fr">Optionnel</span>
        </label>
      </div>

      <button type="submit">
        <span lang="en">Submit</span>
        <span lang="es">Enviar</span>
        <span lang="fr">Envoyer</span>
      </button>
    </form>

    <div id="success" class="success hidden">
      <span lang="en">Thanks! Your response has been recorded.</span>
      <span lang="es">¡Gracias! Su respuesta ha sido registrada.</span>
      <span lang="fr">Merci ! Votre réponse a été enregistrée.</span>
    </div>

    <script>
      const fakeGetformio = true;
      const form = document.getElementById("rsvp-form");
      const success = document.getElementById("success");

      const attendingRadios = document.querySelectorAll('input[name="attending"]');
      const plus1Radios = document.querySelectorAll('input[name="plus1"]');
      const kidCountSelect = document.getElementById('kid-count-input');

      const KID_INDEXABLE_IDS = [
        'kid-name-',
      ];

      const ATTENDING_TOGGLEABLE_IDS = [
        'plus1-fieldset',
        'allergies-main',
        'diet-fieldset',
        'diet-main',
#if USE_PREBODA_PROMPT
        'preboda-fieldset',
#endif
        'kid-count-label',
        'kid-count-input',
        'kid-names-label',
        ...[1, 2, 3, 4].map(i => KID_INDEXABLE_IDS.map(s => `${s}${i}`)).flat(),
        'songrequest-label',
        'songrequest-input',
      ];

      function setVisibilityId(id, visible) {
        setVisibilityElem(document.getElementById(id), visible);
      }

      function setVisibilityElem(elem, visible) {
        elem && (elem.style.display = visible ? "" : 'none');
      }

      function isAttendingTicked() {
        return document.querySelector('input[name="attending"]:checked')?.value === 'yes';
      }

      function isPlus1Ticked() {
        return document.querySelector('input[name="plus1"]:checked')?.value === 'yes';
      }

      function getKidCount() {
        return kidCountSelect.value;
      }

      function updateElements(enabled, ids) {
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;

          if ('disabled' in el) {
            el.disabled = !enabled;
          }

          el.classList.toggle('disabled', !enabled);
        });
      }

      function updatePlus1Fields(visible) {
        for (const row of document.querySelectorAll('.plus1-row')) {
          setVisibilityElem(row, visible);
        }
      }

      function updateAttendingFields(attending) {
        updateElements(attending, ATTENDING_TOGGLEABLE_IDS);
        updatePlus1Fields(attending && isPlus1Ticked());
        updateKidsFields(getKidCount());
      }

      function updateKidsFields(value) {
        let visibility;
        switch (value) {
          case '1':
            visibility = [true , false, false, false];
            break;
          case '2':
            visibility = [true , true , false, false];
            break;
          case '3':
            visibility = [true , true , true , false];
            break;
          case '4':
            visibility = [true , true , true , true ];
            break;
          default:
            visibility = [false, false, false, false];
            break;
        }

        setVisibilityId('kid-names-div', visibility[0]);
        for (const i of [0, 1, 2, 3]) {
          for (const s of KID_INDEXABLE_IDS) {
            setVisibilityId(`${s}${i+1}`, visibility[i]);
          }
        }
      }

      function serializeForm() {
        const formData = new FormData(form);
        const obj = {};
        formData.forEach((value, key) => {
          if (obj[key]) {
            if (Array.isArray(obj[key])) {
              obj[key].push(value);
            } else {
              obj[key] = [obj[key], value];
            }
          } else {
            obj[key] = value;
          }
        });
        return obj;
      }

      // Add handlers for disabling some fields:
      const onPlus1Change = () => updatePlus1Fields(isAttendingTicked() && isPlus1Ticked());
      const onAttendingChange = () => updateAttendingFields(isAttendingTicked());
      const onKidCountChange = (event) => updateKidsFields(event.target.value);
      plus1Radios.forEach(r => r.addEventListener('change', onPlus1Change));
      attendingRadios.forEach(r => r.addEventListener('change', onAttendingChange));
      kidCountSelect.addEventListener('change', onKidCountChange);

      // Form submit
      form.addEventListener('submit', async e => {
        e.preventDefault();

        if (fakeGetformio) {
          form.classList.add('hidden');
          success.classList.remove('hidden');

          // (Debug) Render form content as JSON
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(serializeForm(), null, 2);
          success.appendChild(pre);
          return;
        }

        const formData = new FormData(form);
        try {
          const res = await fetch(form.action, { method:'POST', body: formData });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          form.classList.add('hidden');
          success.classList.remove('hidden');
        } catch(err) {
          console.error(err);
          alert('Submission failed. Please try again.');
        }
      });

      // Initialize state
      updateAttendingFields(isAttendingTicked());
    </script>
  </body>
</html>
